---
layout:     post
title:      一致性hash实现？
category: blog
description: 一致性hash是很多分布式系统（缓存）通用的实现方式，这里用java模拟实现一致性hash。
---
一致性哈希算法是分布式系统中常用的算法。比如，一个分布式的存储系统，要将数据存储到具体的节点上，如果采用普通的hash方法，将数据映射到具体的节点上，如key%N，key是数据的key，N是机器节点数，如果有一个机器加入或退出这个集群，则所有的数据映射都无效了，如果是持久化存储则要做数据迁移，如果是分布式缓存，则其他缓存就失效了。
    因此，引入了一致性哈希算法
    
* <a href="https://github.com/xiaohan008007/lu/blob/master/src/main/java/com/taotaosou/lu/common/hash/method2/VirtualHashIdentical.java">直接看代码实现吧</a>

输出结果：

~~~java

[192.168.0.0:111]加入集合中, 其Hash值为447409781
[192.168.0.1:111]加入集合中, 其Hash值为1010653094
[192.168.0.2:111]加入集合中, 其Hash值为1080384917
[192.168.0.3:111]加入集合中, 其Hash值为2130759017
[192.168.0.4:111]加入集合中, 其Hash值为1601008969

虚拟节点[192.168.0.0:111&&VN0]被添加, hash值为441276990
虚拟节点[192.168.0.0:111&&VN1]被添加, hash值为7212075
虚拟节点[192.168.0.0:111&&VN2]被添加, hash值为1956600191
虚拟节点[192.168.0.0:111&&VN3]被添加, hash值为880099582
虚拟节点[192.168.0.0:111&&VN4]被添加, hash值为1775594257
虚拟节点[192.168.0.1:111&&VN0]被添加, hash值为1589670672
虚拟节点[192.168.0.1:111&&VN1]被添加, hash值为1624001080
虚拟节点[192.168.0.1:111&&VN2]被添加, hash值为1773104951
虚拟节点[192.168.0.1:111&&VN3]被添加, hash值为1648864917
虚拟节点[192.168.0.1:111&&VN4]被添加, hash值为1605726925
虚拟节点[192.168.0.2:111&&VN0]被添加, hash值为281646770
虚拟节点[192.168.0.2:111&&VN1]被添加, hash值为866565852
虚拟节点[192.168.0.2:111&&VN2]被添加, hash值为1993194878
虚拟节点[192.168.0.2:111&&VN3]被添加, hash值为1815821653
虚拟节点[192.168.0.2:111&&VN4]被添加, hash值为1285435563
虚拟节点[192.168.0.3:111&&VN0]被添加, hash值为206429284
虚拟节点[192.168.0.3:111&&VN1]被添加, hash值为1198719942
虚拟节点[192.168.0.3:111&&VN2]被添加, hash值为1004742944
虚拟节点[192.168.0.3:111&&VN3]被添加, hash值为1620159605
虚拟节点[192.168.0.3:111&&VN4]被添加, hash值为1133756370
虚拟节点[192.168.0.4:111&&VN0]被添加, hash值为1109095769
虚拟节点[192.168.0.4:111&&VN1]被添加, hash值为458370133
虚拟节点[192.168.0.4:111&&VN2]被添加, hash值为1490699463
虚拟节点[192.168.0.4:111&&VN3]被添加, hash值为1198431876
虚拟节点[192.168.0.4:111&&VN4]被添加, hash值为554406

美国-的hash值为413938569,被路由到节点192.168.0.0:111
俄罗斯-的hash值为1196559832,被路由到节点192.168.0.4:111
中国-的hash值为1625483750,被路由到节点192.168.0.1:111

虚拟节点[192.168.0.0:111&&VN0]被添加, hash值为441276990
虚拟节点[192.168.0.0:111&&VN1]被添加, hash值为7212075
虚拟节点[192.168.0.0:111&&VN2]被添加, hash值为1956600191
虚拟节点[192.168.0.0:111&&VN3]被添加, hash值为880099582
虚拟节点[192.168.0.0:111&&VN4]被添加, hash值为1775594257
移除真实节点为192.168.0.0:111的虚拟地址[7212075:192.168.0.0:111&&VN1]
移除真实节点为192.168.0.0:111的虚拟地址[441276990:192.168.0.0:111&&VN0]
移除真实节点为192.168.0.0:111的虚拟地址[880099582:192.168.0.0:111&&VN3]
移除真实节点为192.168.0.0:111的虚拟地址[1775594257:192.168.0.0:111&&VN4]
移除真实节点为192.168.0.0:111的虚拟地址[1956600191:192.168.0.0:111&&VN2]
移除物理机192.168.0.0:111后分配的hash地址

美国-的hash值为413938569,被路由到节点192.168.0.4:111
俄罗斯-的hash值为1196559832,被路由到节点192.168.0.4:111
中国-的hash值为1625483750,被路由到节点192.168.0.1:111

虚拟节点[192.168.0.0:111&&VN0]被添加, hash值为441276990
虚拟节点[192.168.0.0:111&&VN1]被添加, hash值为7212075
虚拟节点[192.168.0.0:111&&VN2]被添加, hash值为1956600191
虚拟节点[192.168.0.0:111&&VN3]被添加, hash值为880099582
虚拟节点[192.168.0.0:111&&VN4]被添加, hash值为1775594257
生成真实节点为192.168.0.0:111的虚拟地址[7212075:192.168.0.0:111&&VN1]
生成真实节点为192.168.0.0:111的虚拟地址[441276990:192.168.0.0:111&&VN0]
生成真实节点为192.168.0.0:111的虚拟地址[880099582:192.168.0.0:111&&VN3]
生成真实节点为192.168.0.0:111的虚拟地址[1775594257:192.168.0.0:111&&VN4]
生成真实节点为192.168.0.0:111的虚拟地址[1956600191:192.168.0.0:111&&VN2]
添加物理机192.168.0.0:111后分配的hash地址

美国-的hash值为413938569,被路由到节点192.168.0.0:111
俄罗斯-的hash值为1196559832,被路由到节点192.168.0.4:111
中国-的hash值为1625483750,被路由到节点192.168.0.1:111

Process finished with exit code 0

~~~

